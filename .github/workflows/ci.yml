name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-backend:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: reservation_salles
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm install

      - name: Create .env file
        working-directory: ./backend
        run: |
          echo "PORT=3000" >> .env
          echo "DB_HOST=localhost" >> .env
          echo "DB_PORT=5432" >> .env
          echo "DB_USER=postgres" >> .env
          echo "DB_PASSWORD=password" >> .env
          echo "DB_NAME=reservation_salles" >> .env
          echo "JWT_SECRET=test_secret_key_for_ci" >> .env

      - name: Initialize database
        working-directory: ./backend
        run: |
          PGPASSWORD=password psql -h localhost -U postgres -d reservation_salles -f src/config/init.sql

      - name: Create test user
        working-directory: ./backend
        run: |
          node -e "
          const bcrypt = require('bcryptjs');
          const { Pool } = require('pg');
          const pool = new Pool({
            host: 'localhost',
            port: 5432,
            user: 'postgres',
            password: 'password',
            database: 'reservation_salles'
          });
          (async () => {
            const hashedPassword = await bcrypt.hash('admin123', 10);
            await pool.query(
              \"INSERT INTO users (name, email, password, role) VALUES (\\\$1, \\\$2, \\\$3, \\\$4)\",
              ['Admin', 'admin@test.com', hashedPassword, 'admin']
            );
            await pool.end();
            console.log('Test user created');
          })();
          "

      - name: Run tests
        working-directory: ./backend
        run: npm test

  build-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
